<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据管理工具 - LinkBoard</title>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* 管理工具特有样式 */
    .data-manager-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .data-manager-header {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .data-manager-section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .data-manager-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tab-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    /* 标题层级优化 */
    .section-group-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
      margin: 25px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .section-group-title:first-child {
      margin-top: 0;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }
    
    .data-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      background: var(--bg-secondary);
    }

    /* 链接管理页面的现有链接容器高度调整 */
    #links-tab .data-list {
      max-height: 800px;
    }
    
    .data-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .data-item:last-child {
      border-bottom: none;
    }
    
    .data-item-info {
      flex: 1;
    }
    
    .data-item-actions {
      display: flex;
      gap: 5px;
    }
    
    /* 分类颜色块样式 */
    .category-color-block {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      margin-right: 8px;
      vertical-align: middle;
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    .status-indicator {
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .json-editor {
      width: 100%;
      min-height: 300px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      color: var(--text-primary);
      box-sizing: border-box;
    }

    .flex-container {
      display: flex;
      gap: 20px;
      position: relative;
    }
    
    .flex-container::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 1px;
      background: var(--border-color);
      transform: translateX(-50%);
      z-index: 1;
    }

    .flex-1 {
      flex: 1;
    }

    .code-preview {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      overflow-y: auto;
      margin: 10px 0;
      min-height: 300px;
    }
    
    /* 生成文件页面特殊布局 */
    #export-tab.active {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px); /* 减去头部和标签栏的高度 */
    }
    
    #export-tab.active .data-manager-section {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-bottom: 0;
    }
    
    #export-tab.active .flex-container {
      flex-shrink: 0;
    }
    
    #export-tab.active #codePreviewContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 20px;
    }
    
    #export-tab.active #codePreview {
      flex: 1;
      min-height: 200px;
      max-height: none;
    }

    /* 网站设置特有样式 */
    .setting-preview {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .preview-item {
      margin-bottom: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .logo-preview {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 5px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .page-title-preview {
      font-size: 14px;
      color: var(--text-primary);
      margin-top: 5px;
      font-style: italic;
      padding: 4px;
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .dashboard-preview {
      margin-top: 5px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .dash-title {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .dash-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .form-group small {
      color: var(--text-secondary);
      font-size: 12px;
      margin-top: 3px;
      display: block;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    
    .form-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 2px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
    }

    /* 标签选择器样式 */
    .tag-item {
      display: inline-block;
      padding: 4px 8px;
      background: var(--primary-color);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .tag-item:hover {
      background: var(--text-secondary);
      transform: translateY(-1px);
    }

    .tag-item.added {
      background: #27ae60;
    }

    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column;
      }
      
      .data-manager-tabs {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        flex: 1;
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="data-manager-container">
    <div class="data-manager-header">
      <h1>🛠️ 数据管理工具</h1>
      <p>管理LinkBoard的分类和链接数据</p>
      <div class="status-indicator status-success" id="statusIndicator">
        系统就绪
      </div>
    </div>

    <div class="data-manager-tabs">
      <button class="tab-btn active" data-tab="categories">分类管理</button>
      <button class="tab-btn" data-tab="links">链接管理</button>
      <button class="tab-btn" data-tab="settings">网站设置</button>
      <button class="tab-btn" data-tab="export">生成文件</button>
    </div>

    <!-- 分类管理 -->
    <div class="tab-content active" id="categories-tab">
      <div class="data-manager-section">
        <h2>分类管理</h2>
        <div class="flex-container">
          <div class="flex-1">
            <h3 class="section-group-title">添加/编辑分类</h3>
            <form id="categoryForm">
              <div class="form-group">
                <label>分类ID</label>
                <input type="text" id="categoryId" placeholder="如：new-category" required>
                <small>注意：ID不能包含特殊字符，建议使用小写字母和连字符</small>
              </div>
              <div class="form-group">
                <label>分类名称</label>
                <input type="text" id="categoryName" placeholder="如：新分类" required>
              </div>
              <div class="form-group">
                <label>图标 (Emoji)</label>
                <input type="text" id="categoryIcon" placeholder="如：🎯" required>
              </div>
              <div class="form-group">
                <label>颜色</label>
                <input type="color" id="categoryColor" value="#3498db" required>
              </div>
              <div class="form-group">
                <label>描述</label>
                <textarea id="categoryDescription" placeholder="分类描述"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">保存分类</button>
              <button type="button" class="btn btn-secondary" id="resetCategoryForm">重置</button>
            </form>
          </div>
          <div class="flex-1">
            <h3 class="section-group-title">现有分类</h3>
            <div class="data-list" id="categoriesList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 链接管理 -->
    <div class="tab-content" id="links-tab">
      <div class="data-manager-section">
        <h2>链接管理</h2>
        <div class="flex-container">
          <div class="flex-1">
            <h3 class="section-group-title">图标设置说明</h3>
            <div class="setting-preview">
              <div class="preview-item">
                <strong>📌 图标设置规则：</strong>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li><strong>图标URL</strong>：输入完整的图标链接地址</li>
                  <li><strong>留空默认</strong>：不填写URL时自动使用 网站域名/favicon.ico</li>
                  <li><strong>支持格式</strong>：.ico、.png、.jpg、.svg</li>
                </ul>
              </div>
              <div class="preview-item">
                <strong>⚠️ 注意事项：</strong>
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li>在线URL可能存在加载失败或跨域问题</li>
                  <li>建议图标尺寸：16x16或32x32像素</li>
                  <li>确保图标URL稳定可访问</li>
                </ul>
              </div>
            </div>
            
            <h3 class="section-group-title">添加/编辑链接</h3>
            <form id="linkForm">
              <div class="form-group">
                <label>所属分类</label>
                <select id="linkCategory" required>
                  <option value="">选择分类</option>
                </select>
              </div>
              <div class="form-group">
                <label>链接标题</label>
                <input type="text" id="linkTitle" placeholder="如：GitHub" required>
              </div>
              <div class="form-group">
                <label>链接地址</label>
                <input type="url" id="linkUrl" placeholder="https://github.com" required>
              </div>
              <div class="form-group">
                <label>描述</label>
                <textarea id="linkDescription" placeholder="链接描述"></textarea>
              </div>
              <div class="form-group">
                <label>图标URL</label>
                <input type="url" id="linkIcon" placeholder="https://example.com/icon.png">
                <small>支持 .ico、.png、.jpg、.svg 格式，留空则自动使用 网站域名/favicon.ico</small>
              </div>
              <div class="form-group">
                <label>标签（用英文逗号分隔）</label>
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                  <input type="text" id="linkTags" placeholder="版本控制,开源,协作" style="flex: 1;">
                  <button type="button" class="btn btn-secondary" id="showExistingTags" title="选择已有标签">🏷️</button>
                </div>
                <div id="existingTagsPanel" style="display: none; margin-top: 8px; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">点击标签快速添加：</div>
                  <div id="existingTagsList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">保存链接</button>
              <button type="button" class="btn btn-secondary" id="resetLinkForm">重置</button>
            </form>
          </div>
          <div class="flex-1">
            <h3 class="section-group-title">现有链接</h3>
            <div class="form-group">
              <select id="linkFilterCategory">
                <option value="">显示所有分类</option>
              </select>
            </div>
            <div class="data-list" id="linksList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 网站设置 -->
    <div class="tab-content" id="settings-tab">
      <div class="data-manager-section">
        <h2>网站设置</h2>
        <p>自定义网站的标题、图标、描述等基本信息。</p>
        
        <div class="flex-container">
          <div class="flex-1">
            <form id="settingsForm">
              <h3 class="section-group-title">基本信息</h3>
              <div class="form-group">
                <label>网站标题</label>
                <input type="text" id="siteTitle" placeholder="LinkBoard">
                <small>显示在侧边栏logo位置</small>
              </div>
              <div class="form-group">
                <label>浏览器页签标题</label>
                <input type="text" id="pageTitle" placeholder="LinkBoard - 链接管理面板">
                <small>显示在浏览器页签上</small>
              </div>
              <div class="form-group">
                <label>网站描述</label>
                <textarea id="siteDescription" placeholder="现代化的收集与管理链接的静态网页框架"></textarea>
                <small>用于SEO meta描述</small>
              </div>
              
              <h3 class="section-group-title">Logo设置</h3>
              <div class="form-group">
                <label>Logo图标（Emoji）</label>
                <input type="text" id="logoIcon" placeholder="🔗" maxlength="2">
                <small>建议使用单个emoji</small>
              </div>
              <div class="form-group">
                <label>Logo文字</label>
                <input type="text" id="logoText" placeholder="LinkBoard">
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="showLogoIcon" checked>
                  显示Logo图标
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="showLogoText" checked>
                  显示Logo文字
                </label>
              </div>
              

              
              <h3 class="section-group-title">Dashboard设置</h3>
              <div class="form-group">
                <label>Dashboard标题</label>
                <input type="text" id="dashboardTitle" placeholder="Dashboard">
              </div>
              <div class="form-group">
                <label>Dashboard副标题</label>
                <input type="text" id="dashboardSubtitle" placeholder="数据统计和网站概览">
              </div>
              <div class="form-group">
                <label>欢迎消息</label>
                <textarea id="welcomeMessage" placeholder="欢迎使用LinkBoard！在这里管理您的链接收藏。"></textarea>
              </div>
              
              <h3 class="section-group-title">SEO设置</h3>
              <div class="form-group">
                <label>关键词</label>
                <input type="text" id="keywords" placeholder="linkboard, 链接管理, 书签, 导航">
                <small>用逗号分隔</small>
              </div>
              <div class="form-group">
                <label>作者</label>
                <input type="text" id="author" placeholder="">
              </div>
              
              <button type="submit" class="btn btn-primary">保存设置</button>
              <button type="button" class="btn btn-secondary" id="resetSettingsForm">重置</button>
            </form>
          </div>
          
          <div class="flex-1">
            <h3 class="section-group-title">设置预览</h3>
            <div class="setting-preview">
              <div class="preview-item">
                <strong>侧边栏Logo:</strong>
                <div class="logo-preview" id="logoPreview">🔗 LinkBoard</div>
              </div>
              <div class="preview-item">
                <strong>浏览器页签:</strong>
                <div class="page-title-preview" id="pageTitlePreview">LinkBoard - 链接管理面板</div>
              </div>
              <div class="preview-item">
                <strong>Dashboard标题:</strong>
                <div class="dashboard-preview" id="dashboardPreview">
                  <div class="dash-title">Dashboard</div>
                  <div class="dash-subtitle">数据统计和网站概览</div>
                </div>
              </div>
            </div>
            
            <h3 class="section-group-title">功能配置</h3>
            <div class="form-group">
              <label>
                <input type="checkbox" id="showStats" checked>
                显示统计信息
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="showSearch" checked>
                显示搜索功能
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="showTags" checked>
                显示标签筛选
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="showCategoryCounts" checked>
                显示分类链接计数
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 生成文件 -->
    <div class="tab-content" id="export-tab">
      <div class="data-manager-section">
        <h2>生成新的数据文件</h2>
        <p>将修改后的数据生成新的 <code>data.js</code> 脚本内容，一键复制后手动替换项目中的文件。</p>
        
        <div class="flex-container">
          <div class="flex-1">
            <h3 class="section-group-title">当前数据统计</h3>
            <div id="dataStats"></div>
            
            <h3 class="section-group-title">生成选项</h3>
            <div class="form-group">
              <label>
                <input type="checkbox" id="includeComments" checked>
                包含注释说明
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="formatCode" checked>
                格式化代码（美化输出）
              </label>
            </div>
            
            <button class="btn btn-success" id="copyDataFile">📋 复制脚本内容</button>
            <button class="btn btn-primary" id="directEditFile">✨ 一键编辑data.js</button>
          </div>
          
          <div class="flex-1">
            <h3 class="section-group-title">使用说明</h3>
            <div style="margin-bottom: 15px;">
              <strong>🎯 智能一键编辑 (Chrome/Edge)</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>点击"✨ 一键编辑data.js"按钮</li>
                <li>系统自动检测并显示当前项目路径</li>
                <li>点击"📋"按钮复制项目路径</li>
                <li>选择"💾 继续保存"打开文件保存对话框</li>
                <li>在地址栏粘贴路径快速跳转到项目文件夹</li>
                <li>确认保存data.js文件（可看到项目中的.js文件）</li>
                <li>保存后刷新页面即可看到更新</li>
              </ul>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>📋 备用方式：手动复制</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>点击"📋 复制脚本内容"按钮</li>
                <li>手动打开项目中的 <code>data.js</code> 文件</li>
                <li>全选内容并粘贴替换</li>
                <li>保存文件并刷新页面</li>
              </ul>
            </div>
            
            <div class="status-indicator status-warning">
              <strong>⚠️ 注意：</strong>请先备份原始的 data.js 文件，以防数据丢失！
            </div>
            
                         <div class="status-indicator status-success">
               <strong>🚀 新功能：</strong>智能路径检测，自动识别项目目录，使用系统文件保存对话框让您看到项目中的.js文件！
             </div>
            
            <div class="status-indicator status-success">
              <strong>✅ 兼容性：</strong>支持现代浏览器(Chrome 86+/Edge 86+)的文件系统访问API。
            </div>
          </div>
        </div>
        
        <!-- 代码预览区域 -->
        <div id="codePreviewContainer">
          <h3 class="section-group-title">代码预览</h3>
          <div class="code-preview" id="codePreview"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 直接加载当前数据 -->
  <script src="data.js"></script>
  <script>
    // 离线数据管理器
    class OfflineDataManager {
      constructor() {
        this.currentData = null;
        this.editingCategoryIndex = -1;
        this.editingLinkCategory = null;
        this.editingLinkIndex = -1;
        this.init();
      }

      init() {
        this.loadCurrentData();
        this.setupEventListeners();
        this.renderAll();
        this.updateStatus('数据加载成功', 'success');
      }

      loadCurrentData() {
        this.currentData = {
          siteConfig: typeof siteConfig !== 'undefined' ? JSON.parse(JSON.stringify(siteConfig)) : null,
          categories: JSON.parse(JSON.stringify(categories)),
          links: JSON.parse(JSON.stringify(links))
        };
        
        // 移除favicon字段（现在是硬编码的）
        if (this.currentData.siteConfig && this.currentData.siteConfig.favicon) {
          delete this.currentData.siteConfig.favicon;
        }
      }

      setupEventListeners() {
        // Tab切换
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
        });

        // 分类表单
        document.getElementById('categoryForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveCategory();
        });
        document.getElementById('resetCategoryForm').addEventListener('click', () => {
          this.resetCategoryForm();
        });

        // 链接表单
        document.getElementById('linkForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveLink();
        });
        document.getElementById('resetLinkForm').addEventListener('click', () => {
          this.resetLinkForm();
        });

        // 复制脚本内容
        document.getElementById('copyDataFile').addEventListener('click', () => {
          this.copyDataFileContent();
        });

        // 一键编辑功能
        document.getElementById('directEditFile').addEventListener('click', () => {
          this.directEditFile();
        });

        // 链接筛选
        document.getElementById('linkFilterCategory').addEventListener('change', () => {
          this.renderLinks();
        });

        // 网站设置
        document.getElementById('settingsForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveSettings();
        });
        document.getElementById('resetSettingsForm').addEventListener('click', () => {
          this.resetSettingsForm();
        });

        // 设置预览
        this.setupSettingsPreview();
        
        // 生成选项预览
        this.setupExportPreview();
        
        // 标签功能
        document.getElementById('showExistingTags').addEventListener('click', () => {
          this.toggleExistingTagsPanel();
        });
      }
      

      


      switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'links') {
          this.updateLinkCategoryOptions();
        } else if (tabName === 'export') {
          this.updateDataStats();
          this.previewGeneratedCode(); // 默认显示预览
        } else if (tabName === 'settings') {
          this.loadSettings();
        }
      }

      renderAll() {
        this.renderCategories();
        this.renderLinks();
        this.updateLinkCategoryOptions();
      }

      renderCategories() {
        const container = document.getElementById('categoriesList');
        container.innerHTML = '';

        this.currentData.categories.forEach((category, index) => {
          if (category.id === 'all') return;

          const div = document.createElement('div');
          div.className = 'data-item';
          div.innerHTML = `
            <div class="data-item-info">
              <strong>
                <span class="category-color-block" style="background-color: ${category.color || '#3498db'}"></span>
                ${category.icon} ${category.name}
              </strong><br>
              <small>ID: ${category.id}</small><br>
              <small>${category.description}</small>
            </div>
            <div class="data-item-actions">
              <button class="btn btn-secondary" onclick="dataManager.editCategory(${index})">编辑</button>
              <button class="btn btn-danger" onclick="dataManager.deleteCategory(${index})">删除</button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      renderLinks() {
        const container = document.getElementById('linksList');
        const filterCategory = document.getElementById('linkFilterCategory').value;
        container.innerHTML = '';

        Object.keys(this.currentData.links).forEach(categoryId => {
          if (categoryId === 'dashboard' || categoryId === 'all') return;
          if (filterCategory && categoryId !== filterCategory) return;

          const categoryData = this.currentData.categories.find(cat => cat.id === categoryId);
          const categoryName = categoryData ? categoryData.name : categoryId;

          this.currentData.links[categoryId].forEach((link, linkIndex) => {
            const div = document.createElement('div');
            div.className = 'data-item';
            div.innerHTML = `
              <div class="data-item-info">
                <strong>${link.title}</strong> <small>(${categoryName})</small><br>
                <small>${link.url}</small><br>
                <small>标签: ${link.tags ? link.tags.join(', ') : '无'}</small>
              </div>
              <div class="data-item-actions">
                <button class="btn btn-secondary" onclick="dataManager.editLink('${categoryId}', ${linkIndex})">编辑</button>
                <button class="btn btn-danger" onclick="dataManager.deleteLink('${categoryId}', ${linkIndex})">删除</button>
              </div>
            `;
            container.appendChild(div);
          });
        });
      }

      updateLinkCategoryOptions() {
        const selects = [
          document.getElementById('linkCategory'),
          document.getElementById('linkFilterCategory')
        ];

        selects.forEach(select => {
          const isFilter = select.id === 'linkFilterCategory';
          const currentValue = select.value;
          
          select.innerHTML = isFilter ? '<option value="">显示所有分类</option>' : '<option value="">选择分类</option>';
          
          this.currentData.categories.forEach(category => {
            if (category.id !== 'all' && category.id !== 'dashboard') {
              const option = document.createElement('option');
              option.value = category.id;
              option.textContent = `${category.icon} ${category.name}`;
              select.appendChild(option);
            }
          });

          if (currentValue) {
            select.value = currentValue;
          }
        });
      }

      // 分类管理
      saveCategory() {
        const category = {
          id: document.getElementById('categoryId').value.trim(),
          name: document.getElementById('categoryName').value.trim(),
          icon: document.getElementById('categoryIcon').value.trim(),
          color: document.getElementById('categoryColor').value,
          description: document.getElementById('categoryDescription').value.trim()
        };

        if (!category.id || !category.name || !category.icon) {
          alert('请填写所有必需字段！');
          return;
        }

        if (!/^[a-z0-9-]+$/.test(category.id)) {
          alert('分类ID只能包含小写字母、数字和连字符！');
          return;
        }

        const existingIndex = this.currentData.categories.findIndex(cat => cat.id === category.id);
        if (existingIndex !== -1 && this.editingCategoryIndex !== existingIndex) {
          alert('分类ID已存在！');
          return;
        }

        if (this.editingCategoryIndex !== -1) {
          const oldCategoryId = this.currentData.categories[this.editingCategoryIndex].id;
          this.currentData.categories[this.editingCategoryIndex] = category;
          
          if (oldCategoryId !== category.id) {
            this.currentData.links[category.id] = this.currentData.links[oldCategoryId] || [];
            delete this.currentData.links[oldCategoryId];
          }
        } else {
          this.currentData.categories.push(category);
          this.currentData.links[category.id] = [];
        }

        this.resetCategoryForm();
        this.renderAll();
        this.updateStatus('分类保存成功', 'success');
      }

      editCategory(index) {
        const category = this.currentData.categories[index];
        this.editingCategoryIndex = index;

        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categoryIcon').value = category.icon;
        document.getElementById('categoryColor').value = category.color;
        document.getElementById('categoryDescription').value = category.description;
      }

      deleteCategory(index) {
        const category = this.currentData.categories[index];
        if (!confirm(`确定要删除分类"${category.name}"吗？这也会删除该分类下的所有链接！`)) {
          return;
        }

        this.currentData.categories.splice(index, 1);
        delete this.currentData.links[category.id];

        this.renderAll();
        this.updateStatus('分类删除成功', 'success');
      }

      resetCategoryForm() {
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryColor').value = '#3498db';
        this.editingCategoryIndex = -1;
      }

      // 链接管理
      saveLink() {
        const categoryId = document.getElementById('linkCategory').value;
        let iconValue = document.getElementById('linkIcon').value.trim();
        const linkUrl = document.getElementById('linkUrl').value.trim();
        
        // 如果图标URL为空，根据链接URL生成默认的favicon.ico路径
        if (!iconValue && linkUrl) {
          try {
            const url = new URL(linkUrl);
            iconValue = `${url.protocol}//${url.host}/favicon.ico`;
          } catch (e) {
            iconValue = 'favicon.ico'; // 如果URL解析失败，使用相对路径
          }
        }
        
        const link = {
          title: document.getElementById('linkTitle').value.trim(),
          url: document.getElementById('linkUrl').value.trim(),
          description: document.getElementById('linkDescription').value.trim(),
          icon: iconValue,
          tags: document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
        };

        if (!categoryId || !link.title || !link.url) {
          alert('请填写所有必需字段！');
          return;
        }

        if (!this.currentData.links[categoryId]) {
          this.currentData.links[categoryId] = [];
        }

        if (this.editingLinkIndex !== -1 && this.editingLinkCategory === categoryId) {
          this.currentData.links[categoryId][this.editingLinkIndex] = link;
        } else if (this.editingLinkIndex !== -1) {
          this.currentData.links[this.editingLinkCategory].splice(this.editingLinkIndex, 1);
          this.currentData.links[categoryId].push(link);
        } else {
          this.currentData.links[categoryId].push(link);
        }

        this.resetLinkForm();
        this.renderLinks();
        this.updateStatus('链接保存成功', 'success');
      }

      editLink(categoryId, linkIndex) {
        const link = this.currentData.links[categoryId][linkIndex];
        this.editingLinkCategory = categoryId;
        this.editingLinkIndex = linkIndex;

        document.getElementById('linkCategory').value = categoryId;
        document.getElementById('linkTitle').value = link.title;
        document.getElementById('linkUrl').value = link.url;
        document.getElementById('linkDescription').value = link.description || '';
        document.getElementById('linkTags').value = link.tags ? link.tags.join(', ') : '';
        
        // 设置图标URL，如果是自动生成的favicon.ico则显示为空
        let iconValue = link.icon || '';
        if (iconValue && iconValue.endsWith('/favicon.ico')) {
          // 检查是否是自动生成的favicon.ico路径，如果是则显示为空让用户知道是自动生成的
          try {
            const linkUrl = new URL(link.url);
            const expectedFavicon = `${linkUrl.protocol}//${linkUrl.host}/favicon.ico`;
            if (iconValue === expectedFavicon) {
              iconValue = ''; // 如果匹配自动生成的路径，显示为空
            }
          } catch (e) {
            // URL解析失败，保持原值
          }
        }
        document.getElementById('linkIcon').value = iconValue;

        this.switchTab('links');
      }

      deleteLink(categoryId, linkIndex) {
        if (!confirm('确定要删除这个链接吗？')) {
          return;
        }

        this.currentData.links[categoryId].splice(linkIndex, 1);
        this.renderLinks();
        this.updateStatus('链接删除成功', 'success');
      }

      resetLinkForm() {
        document.getElementById('linkForm').reset();
        this.editingLinkCategory = null;
        this.editingLinkIndex = -1;
      }

      // 生成文件
      updateDataStats() {
        const totalCategories = this.currentData.categories.filter(cat => cat.id !== 'all').length;
        let totalLinks = 0;
        
        Object.keys(this.currentData.links).forEach(categoryId => {
          if (categoryId !== 'dashboard' && categoryId !== 'all') {
            totalLinks += this.currentData.links[categoryId].length;
          }
        });

        document.getElementById('dataStats').innerHTML = `
          <p><strong>分类数量：</strong>${totalCategories}</p>
          <p><strong>链接总数：</strong>${totalLinks}</p>
          <p><strong>最后修改：</strong>${new Date().toLocaleString()}</p>
        `;
      }

      // 网站设置相关方法
      loadSettings() {
        if (typeof siteConfig !== 'undefined') {
          // 基本信息
          document.getElementById('siteTitle').value = siteConfig.title || '';
          document.getElementById('pageTitle').value = siteConfig.pageTitle || '';
          document.getElementById('siteDescription').value = siteConfig.description || '';
          
          // Logo设置
          if (siteConfig.logo) {
            document.getElementById('logoIcon').value = siteConfig.logo.icon || '';
            document.getElementById('logoText').value = siteConfig.logo.text || '';
            document.getElementById('showLogoIcon').checked = siteConfig.logo.showIcon !== false;
            document.getElementById('showLogoText').checked = siteConfig.logo.showText !== false;
          }
          

          
          // Dashboard设置
          if (siteConfig.dashboard) {
            document.getElementById('dashboardTitle').value = siteConfig.dashboard.title || '';
            document.getElementById('dashboardSubtitle').value = siteConfig.dashboard.subtitle || '';
            document.getElementById('welcomeMessage').value = siteConfig.dashboard.welcomeMessage || '';
          }
          
          // SEO设置
          if (siteConfig.meta) {
            document.getElementById('keywords').value = siteConfig.meta.keywords || '';
            document.getElementById('author').value = siteConfig.meta.author || '';
          }
          
          // 功能配置
          if (siteConfig.features) {
            document.getElementById('showStats').checked = siteConfig.features.showStats !== false;
            document.getElementById('showSearch').checked = siteConfig.features.showSearch !== false;
            document.getElementById('showTags').checked = siteConfig.features.showTags !== false;
            document.getElementById('showCategoryCounts').checked = siteConfig.features.showCategoryCounts !== false;
          }
          
          this.updateSettingsPreview();
        }
      }
      
      saveSettings() {
        // 收集表单数据
        const settings = {
          title: document.getElementById('siteTitle').value.trim(),
          subtitle: document.getElementById('pageTitle').value.trim(),
          description: document.getElementById('siteDescription').value.trim(),
          pageTitle: document.getElementById('pageTitle').value.trim(),
          
          logo: {
            text: document.getElementById('logoText').value.trim(),
            icon: document.getElementById('logoIcon').value.trim(),
            showIcon: document.getElementById('showLogoIcon').checked,
            showText: document.getElementById('showLogoText').checked
          },
          
          dashboard: {
            title: document.getElementById('dashboardTitle').value.trim(),
            subtitle: document.getElementById('dashboardSubtitle').value.trim(),
            welcomeMessage: document.getElementById('welcomeMessage').value.trim()
          },
          
          meta: {
            keywords: document.getElementById('keywords').value.trim(),
            author: document.getElementById('author').value.trim(),
            language: 'zh-CN'
          },
          
          features: {
            showStats: document.getElementById('showStats').checked,
            showSearch: document.getElementById('showSearch').checked,
            showTags: document.getElementById('showTags').checked,
            showCategoryCounts: document.getElementById('showCategoryCounts').checked
          },
          
          theme: {
            primaryColor: '#3498db',
            accentColor: '#2ecc71',
            darkMode: false
          },
          
          footer: {
            copyright: '© 2024 LinkBoard. All rights reserved.',
            showCopyright: false,
            links: []
          }
        };
        
        // 更新当前数据
        this.currentData.siteConfig = settings;
        
        this.updateSettingsPreview();
        this.updateStatus('网站设置保存成功', 'success');
      }
      
      resetSettingsForm() {
        // 重置为默认值
        document.getElementById('siteTitle').value = 'LinkBoard';
        document.getElementById('pageTitle').value = 'LinkBoard - 链接管理面板';
        document.getElementById('siteDescription').value = '现代化的收集与管理链接的静态网页框架';
        document.getElementById('logoIcon').value = '🔗';
        document.getElementById('logoText').value = 'LinkBoard';
        document.getElementById('showLogoIcon').checked = true;
        document.getElementById('showLogoText').checked = true;
        document.getElementById('dashboardTitle').value = 'Dashboard';
        document.getElementById('dashboardSubtitle').value = '数据统计和网站概览';
        document.getElementById('welcomeMessage').value = '欢迎使用LinkBoard！在这里管理您的链接收藏。';
        document.getElementById('keywords').value = 'linkboard, 链接管理, 书签, 导航, 收藏夹';
        document.getElementById('author').value = '';
        document.getElementById('showStats').checked = true;
        document.getElementById('showSearch').checked = true;
        document.getElementById('showTags').checked = true;
        document.getElementById('showCategoryCounts').checked = true;
        
        this.updateSettingsPreview();
      }
      
      setupSettingsPreview() {
        // 为所有设置输入框添加实时预览
        const inputs = [
          'siteTitle', 'pageTitle', 'logoIcon', 'logoText', 
          'showLogoIcon', 'showLogoText', 'dashboardTitle', 'dashboardSubtitle'
        ];
        
        inputs.forEach(inputId => {
          const element = document.getElementById(inputId);
          if (element) {
            element.addEventListener('input', () => this.updateSettingsPreview());
            element.addEventListener('change', () => this.updateSettingsPreview());
          }
        });
      }
      
      updateSettingsPreview() {
        // 更新Logo预览
        const logoIcon = document.getElementById('logoIcon').value || '🔗';
        const logoText = document.getElementById('logoText').value || 'LinkBoard';
        const showIcon = document.getElementById('showLogoIcon').checked;
        const showText = document.getElementById('showLogoText').checked;
        
        let logoContent = '';
        if (showIcon) logoContent += logoIcon + ' ';
        if (showText) logoContent += logoText;
        
        document.getElementById('logoPreview').textContent = logoContent || 'LinkBoard';
        
        // 更新页面标题预览
        const pageTitle = document.getElementById('pageTitle').value || 'LinkBoard - 链接管理面板';
        document.getElementById('pageTitlePreview').textContent = pageTitle;
        
        // 更新Dashboard预览
        const dashTitle = document.getElementById('dashboardTitle').value || 'Dashboard';
        const dashSubtitle = document.getElementById('dashboardSubtitle').value || '数据统计和网站概览';
        
        document.querySelector('.dash-title').textContent = dashTitle;
        document.querySelector('.dash-subtitle').textContent = dashSubtitle;
      }
      
      setupExportPreview() {
        // 为生成选项添加实时预览
        const exportOptions = ['includeComments', 'formatCode'];
        
        exportOptions.forEach(optionId => {
          const element = document.getElementById(optionId);
          if (element) {
            element.addEventListener('change', () => {
              // 如果当前在export标签页，更新预览
              const exportTab = document.getElementById('export-tab');
              if (exportTab && exportTab.classList.contains('active')) {
                this.previewGeneratedCode();
              }
            });
          }
        });
      }

      // 将JavaScript对象转换为正确的JavaScript代码格式
      objectToJavaScript(obj, indent = 0) {
        const spaces = '  '.repeat(indent);
        const nextSpaces = '  '.repeat(indent + 1);
        
        if (obj === null) return 'null';
        if (obj === undefined) return 'undefined';
        if (typeof obj === 'string') return `'${obj.replace(/'/g, "\\'")}'`;
        if (typeof obj === 'number' || typeof obj === 'boolean') return obj.toString();
        
        if (Array.isArray(obj)) {
          if (obj.length === 0) return '[]';
          if (obj.every(item => typeof item === 'string')) {
            // 简化字符串数组的格式，放在一行
            return `[${obj.map(item => `'${item.replace(/'/g, "\\'")}'`).join(', ')}]`;
          }
          return `[\n${obj.map(item => nextSpaces + this.objectToJavaScript(item, indent + 1)).join(',\n')}\n${spaces}]`;
        }
        
        if (typeof obj === 'object') {
          const keys = Object.keys(obj);
          if (keys.length === 0) return '{}';
          
          const items = keys.map(key => {
            const value = this.objectToJavaScript(obj[key], indent + 1);
            return `${nextSpaces}'${key}': ${value}`;
          });
          
          return `{\n${items.join(',\n')}\n${spaces}}`;
        }
        
        return String(obj);
      }

      generateDataFileContent() {
        const includeComments = document.getElementById('includeComments').checked;
        const formatCode = document.getElementById('formatCode').checked;

        let content = '';
        
        if (includeComments) {
          content += `// 网站配置数据\n// 自动生成于 ${new Date().toLocaleString()}\n`;
        }
        
        // 生成siteConfig（排除favicon字段，因为它现在是硬编码的）
        if (this.currentData.siteConfig) {
          const siteConfigCopy = { ...this.currentData.siteConfig };
          delete siteConfigCopy.favicon; // 移除favicon字段
          
          content += 'const siteConfig = ';
          if (formatCode) {
            content += this.objectToJavaScript(siteConfigCopy);
          } else {
            content += this.objectToJavaScript(siteConfigCopy).replace(/\s+/g, ' ').replace(/,\s*}/g, '}');
          }
          content += ';\n\n';
        }
        
        if (includeComments) {
          content += `// 分类数据\n`;
        }
        
        content += 'const categories = ';
        if (formatCode) {
          content += this.objectToJavaScript(this.currentData.categories);
        } else {
          content += this.objectToJavaScript(this.currentData.categories).replace(/\s+/g, ' ').replace(/,\s*}/g, '}');
        }
        content += ';\n\n';

        if (includeComments) {
          content += '// 链接数据\n';
        }
        
        content += 'const links = ';
        if (formatCode) {
          content += this.objectToJavaScript(this.currentData.links);
        } else {
          content += this.objectToJavaScript(this.currentData.links).replace(/\s+/g, ' ').replace(/,\s*}/g, '}');
        }
        content += ';';

        return content;
      }

      previewGeneratedCode() {
        const code = this.generateDataFileContent();
        const previewElement = document.getElementById('codePreview');
        previewElement.textContent = code;
      }

      async copyDataFileContent() {
        const content = this.generateDataFileContent();
        
        try {
          await navigator.clipboard.writeText(content);
          this.updateStatus('脚本内容已复制到剪贴板！可直接粘贴到 data.js 文件中', 'success');
        } catch (err) {
          // 降级方案：创建一个文本域并选中复制
          const textArea = document.createElement('textarea');
          textArea.value = content;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            document.execCommand('copy');
            this.updateStatus('脚本内容已复制到剪贴板！可直接粘贴到 data.js 文件中', 'success');
          } catch (copyErr) {
            this.updateStatus('复制失败，请手动复制预览代码', 'error');
          }
          
          document.body.removeChild(textArea);
        }
      }

      // 获取当前项目的基础路径
      getCurrentProjectPath() {
        const currentUrl = window.location.href;
        const currentPath = window.location.pathname;
        
        // 对于 file:// 协议，从URL中提取目录路径
        if (currentUrl.startsWith('file://')) {
          // 移除文件名，获取目录路径
          const dirPath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
          return {
            fullPath: dirPath,
            displayPath: decodeURIComponent(dirPath),
            isFileProtocol: true
          };
        } else {
          // 对于 http/https 协议
          const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
          return {
            fullPath: window.location.origin + basePath,
            displayPath: basePath,
            isFileProtocol: false
          };
        }
      }

            // 增强的一键编辑功能 - 智能路径检测
      async directEditFile() {
        try {
          // 检查浏览器支持
          if (!('showSaveFilePicker' in window)) {
            this.updateStatus('您的浏览器不支持文件系统访问API，请使用Chrome 86+或Edge 86+', 'warning');
            return;
          }
          
          const content = this.generateDataFileContent();
          const projectPath = this.getCurrentProjectPath();
          
          // 显示路径检测和操作指引
          const shouldProceed = await this.showPathGuideModal(projectPath.displayPath);
          
          if (!shouldProceed) {
            this.updateStatus('操作已取消', 'warning');
            return;
          }
          
          // 显示当前检测到的项目路径提示
          this.updateStatus(`💡 请在文件保存对话框中导航到: ${projectPath.displayPath}`, 'warning');
          
          // 使用系统文件保存对话框
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: 'data.js',
            types: [{
              description: 'JavaScript files',
              accept: { 'text/javascript': ['.js'] }
            }]
          });
          
          // 创建可写流并写入内容
          const writable = await fileHandle.createWritable();
          await writable.write(content);
          await writable.close();
          
          // 获取文件信息用于确认
          let fileInfo = '';
          try {
            const file = await fileHandle.getFile();
            fileInfo = ` (大小: ${(file.size / 1024).toFixed(1)}KB, 修改时间: ${new Date(file.lastModified).toLocaleString()})`;
          } catch (e) {
            // 忽略获取文件信息失败的错误
          }
          
          this.updateStatus(`🎉 data.js文件已保存成功！${fileInfo} 刷新页面即可看到更新`, 'success');
          
          // 提供刷新页面的选项
          setTimeout(() => {
            if (confirm('数据已保存，是否立即刷新页面查看更新？')) {
              window.location.reload();
            }
          }, 1000);
          
        } catch (err) {
          if (err.name === 'AbortError') {
            this.updateStatus('操作已取消', 'warning');
          } else {
            console.error('文件保存失败:', err);
            this.updateStatus('文件保存失败，请尝试其他方式', 'error');
          }
        }
      }

      // 复制路径到剪贴板
      async copyPathToClipboard(path) {
        try {
          // 转换为Windows路径格式
          const windowsPath = path.replace('file:///', '').replace(/\//g, '\\');
          await navigator.clipboard.writeText(windowsPath);
          return true;
        } catch (err) {
          console.error('复制路径失败:', err);
          return false;
        }
      }

      // 显示路径指导模态框
      async showPathGuideModal(projectPath) {
        return new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: inherit;
          `;
          
          // 转换路径为Windows格式显示
          const windowsPath = projectPath.replace('file:///', '').replace(/\//g, '\\');
          
          modal.innerHTML = `
            <div style="
              background: var(--card-bg, #fff);
              padding: 30px;
              border-radius: 12px;
              max-width: 600px;
              text-align: left;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              color: var(--text-primary, #333);
            ">
              <h3 style="margin-top: 0; color: var(--primary-color, #3498db); text-align: center;">🎯 智能路径指引</h3>
              
              <div style="
                background: var(--bg-secondary, #f8f9fa);
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
                border: 1px solid var(--border-color, #ddd);
              ">
                <div style="font-weight: bold; margin-bottom: 8px;">📍 检测到的项目路径：</div>
                <div style="
                  font-family: monospace;
                  font-size: 12px;
                  word-break: break-all;
                  background: white;
                  padding: 8px;
                  border-radius: 4px;
                  border: 1px solid #ddd;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                ">${windowsPath}<button id="copyPath" style="
                  padding: 4px 8px;
                  background: var(--primary-color, #3498db);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 10px;
                  flex-shrink: 0;
                " title="复制路径">📋</button></div>
              </div>
              
                             <div style="
                 background: #e8f5e8;
                 padding: 15px;
                 border-radius: 8px;
                 margin: 15px 0;
                 border: 1px solid #c3e6cb;
                 color: #155724;
               ">
                 <div style="font-weight: bold; margin-bottom: 8px;">💾 文件保存说明：</div>
                 <div style="font-size: 14px;">系统将打开文件保存对话框，您可以看到项目文件夹中的.js文件，确认保存位置后替换原有文件。</div>
               </div>
               
               <div style="margin: 20px 0;">
                 <div style="font-weight: bold; margin-bottom: 10px;">📁 操作步骤：</div>
                 <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
                   <li>点击上方"📋"按钮复制项目路径</li>
                   <li>点击"继续保存"打开文件保存对话框</li>
                   <li>在地址栏粘贴路径并回车，快速跳转到项目文件夹</li>
                   <li>选择或输入"data.js"文件名，确认保存</li>
                 </ol>
               </div>
               
               <div style="text-align: center; margin-top: 25px;">
                 <button id="continueOperation" style="
                   padding: 15px 30px;
                   background: var(--primary-color, #3498db);
                   color: white;
                   border: none;
                   border-radius: 8px;
                   cursor: pointer;
                   font-size: 16px;
                   margin-right: 15px;
                   font-weight: bold;
                   box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
                 ">💾 继续保存</button>
                 <button id="cancelOperation" style="
                   padding: 15px 30px;
                   background: #e74c3c;
                   color: white;
                   border: none;
                   border-radius: 8px;
                   cursor: pointer;
                   font-size: 16px;
                   font-weight: bold;
                   box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
                 ">❌ 取消</button>
               </div>
              
              <div style="
                font-size: 12px;
                color: var(--text-secondary, #666);
                margin-top: 15px;
                text-align: center;
                padding: 10px;
                background: var(--bg-secondary, #f8f9fa);
                border-radius: 6px;
              ">
                💡 小贴士：第一次选择文件夹后，浏览器会记住位置，后续操作会更方便
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // 复制路径功能
          document.getElementById('copyPath').onclick = async () => {
            const success = await this.copyPathToClipboard(projectPath);
            const btn = document.getElementById('copyPath');
            if (success) {
              btn.textContent = '✅';
              btn.style.background = '#27ae60';
              setTimeout(() => {
                btn.textContent = '📋';
                btn.style.background = 'var(--primary-color, #3498db)';
              }, 2000);
            } else {
              btn.textContent = '❌';
              btn.style.background = '#e74c3c';
              setTimeout(() => {
                btn.textContent = '📋';
                btn.style.background = 'var(--primary-color, #3498db)';
              }, 2000);
            }
          };
          
                     document.getElementById('continueOperation').onclick = () => {
             document.body.removeChild(modal);
             resolve(true);
           };
           
           document.getElementById('cancelOperation').onclick = () => {
             document.body.removeChild(modal);
             resolve(false); // 返回false表示取消操作
           };
          
                     // 点击背景关闭
           modal.onclick = (e) => {
             if (e.target === modal) {
               document.body.removeChild(modal);
               resolve(false);
             }
           };
        });
      }

      // 标签功能相关方法
      getAllExistingTags() {
        const tags = new Set();
        
        Object.keys(this.currentData.links).forEach(categoryId => {
          if (categoryId === 'dashboard' || categoryId === 'all') return;
          
          this.currentData.links[categoryId].forEach(link => {
            if (link.tags && Array.isArray(link.tags)) {
              link.tags.forEach(tag => {
                if (tag.trim()) {
                  tags.add(tag.trim());
                }
              });
            }
          });
        });
        
        return Array.from(tags).sort();
      }
      
      toggleExistingTagsPanel() {
        const panel = document.getElementById('existingTagsPanel');
        const isVisible = panel.style.display !== 'none';
        
        if (isVisible) {
          panel.style.display = 'none';
        } else {
          this.renderExistingTags();
          panel.style.display = 'block';
        }
      }
      
      renderExistingTags() {
        const container = document.getElementById('existingTagsList');
        const existingTags = this.getAllExistingTags();
        
        container.innerHTML = '';
        
        if (existingTags.length === 0) {
          container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px;">暂无已有标签</div>';
          return;
        }
        
        existingTags.forEach(tag => {
          const tagButton = document.createElement('button');
          tagButton.className = 'tag-item';
          tagButton.textContent = tag;
          tagButton.type = 'button';
          tagButton.addEventListener('click', () => {
            this.addTagToInput(tag, tagButton);
          });
          
          container.appendChild(tagButton);
        });
      }
      
      addTagToInput(tag, buttonElement) {
        const tagsInput = document.getElementById('linkTags');
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        // 检查标签是否已存在
        if (currentTags.includes(tag)) {
          // 标签已存在，给出视觉反馈
          buttonElement.classList.add('added');
          setTimeout(() => {
            buttonElement.classList.remove('added');
          }, 1000);
          this.updateStatus(`标签"${tag}"已存在`, 'warning');
          return;
        }
        
        // 添加标签
        currentTags.push(tag);
        tagsInput.value = currentTags.join(', ');
        
        // 给出成功反馈
        buttonElement.classList.add('added');
        setTimeout(() => {
          buttonElement.classList.remove('added');
        }, 1000);
        
        this.updateStatus(`已添加标签"${tag}"`, 'success');
      }

      updateStatus(message, type) {
        const indicator = document.getElementById('statusIndicator');
        indicator.textContent = message;
        indicator.className = `status-indicator status-${type}`;
        
        if (type === 'success') {
          setTimeout(() => {
            indicator.textContent = '系统就绪 - 当前使用离线模式';
            indicator.className = 'status-indicator status-success';
          }, 3000);
        }
      }
    }

    // 初始化
    let dataManager;
    document.addEventListener('DOMContentLoaded', () => {
      dataManager = new OfflineDataManager();
    });
  </script>
</body>
</html> 
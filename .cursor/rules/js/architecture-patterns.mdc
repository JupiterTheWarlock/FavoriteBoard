---
globs: js/**/*.js
description: FavoriteBoardé¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µ
---

# FavoriteBoard æ¶æ„è®¾è®¡æ¨¡å¼

## ğŸ—ï¸ é¡¹ç›®æ¶æ„å±‚æ¬¡

### åˆ†å±‚æ¶æ„è®¾è®¡
```
FavoriteBoardæ¶æ„
â”œâ”€â”€ è¡¨ç°å±‚ (Presentation Layer)
â”‚   â”œâ”€â”€ main.js              # åº”ç”¨å®¹å™¨/åè°ƒå™¨
â”‚   â””â”€â”€ tabs/                # Tabä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ UIç®¡ç†å±‚ (UI Management Layer)  
â”‚   â””â”€â”€ ui/                  # UIç»„ä»¶ç®¡ç†å™¨
â”œâ”€â”€ æ ¸å¿ƒå±‚ (Core Layer)
â”‚   â””â”€â”€ core/                # äº‹ä»¶æ€»çº¿ã€çŠ¶æ€ç®¡ç†
â”œâ”€â”€ æ•°æ®å±‚ (Data Layer)
â”‚   â””â”€â”€ data/                # æ•°æ®ç®¡ç†ã€å¤„ç†
â””â”€â”€ å·¥å…·å±‚ (Utility Layer)
    â”œâ”€â”€ utils/               # çº¯å·¥å…·å‡½æ•°
    â””â”€â”€ config/              # é…ç½®ç®¡ç†
```

### ä¾èµ–è§„åˆ™
- **å•å‘ä¾èµ–**: ä¸Šå±‚å¯ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸èƒ½ä¾èµ–ä¸Šå±‚
- **æ ¸å¿ƒç‹¬ç«‹**: core/ å±‚å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚
- **å·¥å…·çº¯å‡€**: utils/ å±‚åªèƒ½æ˜¯çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨

## ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture)

### EventBusæ¨¡å¼å®ç°
```javascript
// âœ… æ ‡å‡†äº‹ä»¶å‘å¸ƒæ¨¡å¼
class ComponentA {
  performAction(data) {
    // æ‰§è¡Œæ“ä½œ
    const result = this.processData(data);
    
    // å‘å¸ƒäº‹ä»¶é€šçŸ¥å…¶ä»–ç»„ä»¶
    this.eventBus.emit('data-processed', {
      source: 'ComponentA',
      result: result,
      timestamp: Date.now()
    });
  }
}

// âœ… æ ‡å‡†äº‹ä»¶è®¢é˜…æ¨¡å¼
class ComponentB {
  constructor(eventBus) {
    this.eventBus = eventBus;
    this.setupEventListeners();
  }
  
  setupEventListeners() {
    // ä½¿ç”¨uniqueé€‰é¡¹é¿å…é‡å¤ç»‘å®š
    this.eventBus.on('data-processed', this.handleDataProcessed.bind(this), { 
      unique: true 
    });
  }
  
  handleDataProcessed(eventData) {
    // å¤„ç†äº‹ä»¶æ•°æ®
  }
  
  destroy() {
    // ç»„ä»¶é”€æ¯æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬
    this.eventBus.off('data-processed', this.handleDataProcessed);
  }
}
```

### äº‹ä»¶å‘½åçº¦å®š
```javascript
// âœ… äº‹ä»¶å‘½åæ¨¡å¼ï¼š[åŠ¨è¯]-[åè¯]-[çŠ¶æ€]
'data-loaded'              // æ•°æ®åŠ è½½å®Œæˆ
'bookmark-created'         // ä¹¦ç­¾åˆ›å»º
'folder-deleted'           // æ–‡ä»¶å¤¹åˆ é™¤
'tab-switched'             // æ ‡ç­¾åˆ‡æ¢
'ui-state-changed'         // UIçŠ¶æ€å˜åŒ–
'search-query-updated'     // æœç´¢æŸ¥è¯¢æ›´æ–°
```

## ğŸ“Š çŠ¶æ€ç®¡ç†æ¨¡å¼ (State Management Pattern)

### é›†ä¸­å¼çŠ¶æ€ç®¡ç†
```javascript
// âœ… StateManagerä½œä¸ºå”¯ä¸€çŠ¶æ€æº
class StateManager {
  constructor() {
    this.state = {
      data: {},        // ä¸šåŠ¡æ•°æ®çŠ¶æ€
      ui: {},          // UIçŠ¶æ€
      tabs: {}         // TabçŠ¶æ€
    };
  }
  
  // çŠ¶æ€æ›´æ–°å¿…é¡»é€šè¿‡setStateæ–¹æ³•
  setState(newState, source = 'unknown') {
    this.state = { ...this.state, ...newState };
    this.notifySubscribers(source);
  }
}

// âœ… ç»„ä»¶è®¢é˜…çŠ¶æ€å˜åŒ–
class UIComponent {
  constructor(stateManager) {
    this.stateManager = stateManager;
    
    // è®¢é˜…ç‰¹å®šçŠ¶æ€è·¯å¾„
    this.stateManager.subscribe(['data.folderTree'], ([folderTree]) => {
      this.updateUI(folderTree);
    });
  }
}
```

### çŠ¶æ€æ›´æ–°æœ€ä½³å®è·µ
```javascript
// âœ… æŒ‡å®šæ“ä½œæºï¼Œä¾¿äºè°ƒè¯•å’Œè¿½è¸ª
this.stateManager.setState({ loading: true }, 'data-fetch-start');

// âœ… æ‰¹é‡çŠ¶æ€æ›´æ–°
this.stateManager.batchUpdate(() => {
  this.stateManager.setState({ data: newData });
  this.stateManager.setUIState({ loading: false });
}, 'data-refresh-complete');

// âœ… æ¡ä»¶çŠ¶æ€æ›´æ–°
if (this.stateManager.getStateValue('ui.loading') !== true) {
  this.stateManager.setUIState({ loading: true }, 'user-action');
}
```

## ğŸ­ å·¥å‚æ¨¡å¼ (Factory Pattern)

### Tabå·¥å‚æ¨¡å¼
```javascript
// âœ… Tabå·¥å‚å®ç°
class TabFactory {
  static createTab(type, instanceId = 'default', data = null) {
    switch (type) {
      case 'dashboard':
        return new DashboardTab(instanceId, data);
      case 'bookmark':
        return new BookmarkTab(instanceId, data);
      case 'settings':
        return new SettingsTab(instanceId, data);
      default:
        throw new Error(`æœªçŸ¥çš„Tabç±»å‹: ${type}`);
    }
  }
}

// âœ… ä½¿ç”¨å·¥å‚åˆ›å»ºTab
const tab = TabFactory.createTab('bookmark', folderId, {
  folderId: folderId,
  folderData: folderData
});
```

### ç»„ä»¶å·¥å‚æ¨¡å¼
```javascript
// âœ… UIç»„ä»¶å·¥å‚
class UIComponentFactory {
  static createDialog(type, config) {
    const dialogTypes = {
      'confirm': () => new ConfirmDialog(config),
      'input': () => new InputDialog(config),
      'folder-selector': () => new FolderSelectorDialog(config)
    };
    
    const factory = dialogTypes[type];
    if (!factory) {
      throw new Error(`æœªçŸ¥çš„å¯¹è¯æ¡†ç±»å‹: ${type}`);
    }
    
    return factory();
  }
}
```

## ğŸ‘€ è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

### çŠ¶æ€è§‚å¯Ÿè€…å®ç°
```javascript
// âœ… StateManagerä½œä¸ºSubject
class StateManager {
  constructor() {
    this.observers = new Map(); // å­˜å‚¨è§‚å¯Ÿè€…
  }
  
  subscribe(statePaths, callback) {
    const key = statePaths.join('.');
    if (!this.observers.has(key)) {
      this.observers.set(key, new Set());
    }
    this.observers.get(key).add(callback);
  }
  
  notifySubscribers(source) {
    this.observers.forEach((callbacks, statePath) => {
      const values = this.extractStateValues(statePath);
      callbacks.forEach(callback => callback(values, source));
    });
  }
}

// âœ… ç»„ä»¶ä½œä¸ºObserver
class UIManager {
  constructor(stateManager) {
    // è®¢é˜…UIçŠ¶æ€å˜åŒ–
    stateManager.subscribe(['ui.sidebarOpen'], ([sidebarOpen]) => {
      this.updateSidebarVisibility(sidebarOpen);
    });
  }
}
```

## ğŸ”§ å•ä¾‹æ¨¡å¼ (Singleton Pattern)

### å…¨å±€ç®¡ç†å™¨å•ä¾‹
```javascript
// âœ… StateManagerå•ä¾‹å®ç°
class StateManager {
  constructor() {
    if (StateManager.instance) {
      return StateManager.instance;
    }
    
    this.state = {};
    StateManager.instance = this;
  }
  
  static getInstance() {
    if (!StateManager.instance) {
      StateManager.instance = new StateManager();
    }
    return StateManager.instance;
  }
}

// âœ… å…¨å±€è®¿é—®ç‚¹
window.stateManager = new StateManager();
```

## ğŸ“ æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

### BaseTabæ¨¡æ¿æ–¹æ³•
```javascript
// âœ… æŠ½è±¡åŸºç±»å®šä¹‰æ¨¡æ¿æ–¹æ³•
class BaseTab {
  constructor(id, title, icon) {
    this.id = id;
    this.title = title;
    this.icon = icon;
  }
  
  // æ¨¡æ¿æ–¹æ³•å®šä¹‰ç®—æ³•éª¨æ¶
  async activate(container, data = null) {
    try {
      await this.beforeRender(data);
      await this.render(container, data);
      await this.afterRender();
      this.bindEvents();
    } catch (error) {
      this.handleRenderError(error);
    }
  }
  
  // é’©å­æ–¹æ³•ï¼Œå­ç±»å¯ä»¥é‡å†™
  async beforeRender(data) { /* é»˜è®¤å®ç° */ }
  async afterRender() { /* é»˜è®¤å®ç° */ }
  
  // æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°
  async render(container, data) {
    throw new Error('å­ç±»å¿…é¡»å®ç°renderæ–¹æ³•');
  }
}

// âœ… å…·ä½“å®ç°ç±»
class BookmarkTab extends BaseTab {
  async render(container, data) {
    // å…·ä½“çš„æ¸²æŸ“é€»è¾‘
  }
  
  async beforeRender(data) {
    // æ•°æ®é¢„å¤„ç†
    this.folderData = await this.loadFolderData(data.folderId);
  }
}
```

## ğŸ¯ é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

### Chrome APIé€‚é…å™¨
```javascript
// âœ… Chrome APIé€‚é…å™¨
class BookmarkAPIAdapter {
  constructor() {
    this.api = chrome.bookmarks;
  }
  
  async getTree() {
    return new Promise((resolve, reject) => {
      this.api.getTree((result) => {
        if (chrome.runtime.lastError) {
          reject(new Error(chrome.runtime.lastError.message));
        } else {
          resolve(this.adaptBookmarkTree(result));
        }
      });
    });
  }
  
  // é€‚é…å™¨æ–¹æ³•ï¼šè½¬æ¢APIæ•°æ®æ ¼å¼
  adaptBookmarkTree(chromeBookmarks) {
    return chromeBookmarks.map(node => ({
      id: node.id,
      title: node.title,
      url: node.url,
      children: node.children ? this.adaptBookmarkTree(node.children) : []
    }));
  }
}
```

## ğŸ® ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

### Tabåˆ‡æ¢ç­–ç•¥
```javascript
// âœ… Tabåˆ‡æ¢ç­–ç•¥æ¥å£
class TabSwitchStrategy {
  async switch(fromTab, toTab, options) {
    throw new Error('ç­–ç•¥ç±»å¿…é¡»å®ç°switchæ–¹æ³•');
  }
}

// âœ… å…·ä½“ç­–ç•¥å®ç°
class SmoothSwitchStrategy extends TabSwitchStrategy {
  async switch(fromTab, toTab, options) {
    await this.fadeOut(fromTab);
    await toTab.activate(options.container, options.data);
    await this.fadeIn(toTab);
  }
}

class InstantSwitchStrategy extends TabSwitchStrategy {
  async switch(fromTab, toTab, options) {
    if (fromTab) fromTab.deactivate();
    await toTab.activate(options.container, options.data);
  }
}

// âœ… ç­–ç•¥ä½¿ç”¨
class TabContainer {
  constructor() {
    this.switchStrategy = new SmoothSwitchStrategy();
  }
  
  setSwitchStrategy(strategy) {
    this.switchStrategy = strategy;
  }
  
  async switchToTab(tabKey, options) {
    const fromTab = this.activeTab;
    const toTab = this.tabs.get(tabKey);
    
    await this.switchStrategy.switch(fromTab, toTab, options);
  }
}
```

## ğŸ”— ç»„åˆæ¨¡å¼ (Composite Pattern)

### UIç»„ä»¶æ ‘ç»“æ„
```javascript
// âœ… ç»„ä»¶æŠ½è±¡åŸºç±»
class UIComponent {
  constructor(id) {
    this.id = id;
    this.children = new Map();
    this.parent = null;
  }
  
  addChild(component) {
    component.parent = this;
    this.children.set(component.id, component);
  }
  
  removeChild(componentId) {
    const component = this.children.get(componentId);
    if (component) {
      component.parent = null;
      this.children.delete(componentId);
    }
  }
  
  // ç»„åˆæ“ä½œï¼šé€’å½’å¤„ç†æ‰€æœ‰å­ç»„ä»¶
  render() {
    this.renderSelf();
    this.children.forEach(child => child.render());
  }
  
  destroy() {
    this.children.forEach(child => child.destroy());
    this.children.clear();
    this.destroySelf();
  }
}

// âœ… å…·ä½“ç»„ä»¶å®ç°
class UIManager extends UIComponent {
  constructor() {
    super('ui-manager');
    
    // æ·»åŠ å­ç»„ä»¶
    this.addChild(new SidebarManager('sidebar'));
    this.addChild(new DialogManager('dialog'));
    this.addChild(new NotificationManager('notification'));
  }
}
```

## ğŸ“‹ å‘½ä»¤æ¨¡å¼ (Command Pattern)

### æ“ä½œå‘½ä»¤å°è£…
```javascript
// âœ… å‘½ä»¤æ¥å£
class Command {
  execute() {
    throw new Error('å‘½ä»¤ç±»å¿…é¡»å®ç°executeæ–¹æ³•');
  }
  
  undo() {
    throw new Error('å‘½ä»¤ç±»å¿…é¡»å®ç°undoæ–¹æ³•');
  }
}

// âœ… å…·ä½“å‘½ä»¤å®ç°
class CreateFolderCommand extends Command {
  constructor(bookmarkManager, parentId, title) {
    super();
    this.bookmarkManager = bookmarkManager;
    this.parentId = parentId;
    this.title = title;
    this.createdFolderId = null;
  }
  
  async execute() {
    const result = await this.bookmarkManager.createFolder(this.parentId, this.title);
    this.createdFolderId = result.id;
    return result;
  }
  
  async undo() {
    if (this.createdFolderId) {
      await this.bookmarkManager.deleteFolder(this.createdFolderId);
      this.createdFolderId = null;
    }
  }
}

// âœ… å‘½ä»¤ç®¡ç†å™¨
class CommandManager {
  constructor() {
    this.history = [];
    this.currentIndex = -1;
  }
  
  async executeCommand(command) {
    // æ¸…é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²
    this.history = this.history.slice(0, this.currentIndex + 1);
    
    // æ‰§è¡Œå‘½ä»¤
    await command.execute();
    
    // æ·»åŠ åˆ°å†å²
    this.history.push(command);
    this.currentIndex++;
  }
  
  async undo() {
    if (this.currentIndex >= 0) {
      const command = this.history[this.currentIndex];
      await command.undo();
      this.currentIndex--;
    }
  }
}
```

## ğŸ”„ è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)

### äº‹ä»¶å¤„ç†é“¾
```javascript
// âœ… äº‹ä»¶å¤„ç†å™¨åŸºç±»
class EventHandler {
  constructor() {
    this.nextHandler = null;
  }
  
  setNext(handler) {
    this.nextHandler = handler;
    return handler;
  }
  
  async handle(event) {
    if (this.canHandle(event)) {
      return await this.doHandle(event);
    }
    
    if (this.nextHandler) {
      return await this.nextHandler.handle(event);
    }
    
    return false;
  }
  
  canHandle(event) {
    throw new Error('å¤„ç†å™¨å¿…é¡»å®ç°canHandleæ–¹æ³•');
  }
  
  async doHandle(event) {
    throw new Error('å¤„ç†å™¨å¿…é¡»å®ç°doHandleæ–¹æ³•');
  }
}

// âœ… å…·ä½“å¤„ç†å™¨
class BookmarkEventHandler extends EventHandler {
  canHandle(event) {
    return event.type.startsWith('bookmark-');
  }
  
  async doHandle(event) {
    console.log(`å¤„ç†ä¹¦ç­¾äº‹ä»¶: ${event.type}`);
    // å¤„ç†é€»è¾‘
    return true;
  }
}

class UIEventHandler extends EventHandler {
  canHandle(event) {
    return event.type.startsWith('ui-');
  }
  
  async doHandle(event) {
    console.log(`å¤„ç†UIäº‹ä»¶: ${event.type}`);
    // å¤„ç†é€»è¾‘
    return true;
  }
}

// âœ… æ„å»ºå¤„ç†é“¾
const bookmarkHandler = new BookmarkEventHandler();
const uiHandler = new UIEventHandler();

bookmarkHandler.setNext(uiHandler);
```

---